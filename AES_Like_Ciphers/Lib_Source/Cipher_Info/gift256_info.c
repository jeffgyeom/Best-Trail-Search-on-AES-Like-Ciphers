#include "astbb.h"
#include "dif_prob.h"
#include "lin_corr.h"
#include "bit_perm_opt.h"

SBOX_O_WRD_t GIFT256_sboxes[64 * 16] =
{
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,

	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe,
	0x1, 0xa, 0x4, 0xc, 0x6, 0xf, 0x3, 0x9, 0x2, 0xd, 0xb, 0x7, 0x5, 0x0, 0x8, 0xe
};

//Bit Permutation
//127||126||125||124||...||3||2||1||0
void GIFT256_diffusion(DIFF_O_WRD_t * out, DIFF_I_WRD_t * in)
{
	char instatebit[256];
	char oustatebit[256];
	CNT_t word_idx;
	CNT_t inbit_idx;
	CNT_t bit_idx;

	//split to bits
	////Word_idx_order  :          0      ||...||      15 
	////InBit_idx_order : || 3|| 2|| 1|| 0||...|| 3|| 2|| 1|| 0||
	////Bit_idx_order   : || 0|| 1|| 2|| 3||...||60||61||62||63||
	for (word_idx = 0; word_idx < 64; word_idx++)
	{
		DIFF_O_WRD_t diff_word = in[word_idx];
		for (inbit_idx = 0; inbit_idx < 4; inbit_idx++)
		{
			bit_idx = 4 * word_idx;
			bit_idx += (4 - 1 - inbit_idx);

			if ((diff_word & (DIFF_O_WRD_t)(1 << inbit_idx)) != 0)
			{
				instatebit[bit_idx] = 1;
			}
			else
			{
				instatebit[bit_idx] = 0;
			}
		}
	}

	//bit permutation
	for (bit_idx = 0; bit_idx < 256; bit_idx++)
	{
		oustatebit[bit_idx] = instatebit[GIFT256_P[bit_idx]];
	}

	//merge to state
	////Bit_idx_order   : || 0|| 1|| 2|| 3||...||60||61||62||63||
	////InBit_idx_order : || 3|| 2|| 1|| 0||...|| 3|| 2|| 1|| 0||
	////Word_idx_order  :          0      ||...||      15 

	for (word_idx = 0; word_idx < 64; word_idx++)
	{
		DIFF_O_WRD_t diff_out_word = 0x0;
		for (inbit_idx = 0; inbit_idx < 4; inbit_idx++)
		{
			DIFF_O_WRD_t mask = (((DIFF_O_WRD_t)1) << inbit_idx);

			bit_idx = 4 * word_idx;
			bit_idx += (4 - 1 - inbit_idx);
			if (oustatebit[bit_idx] == 0x1)
				diff_out_word = diff_out_word | mask;
		}
		out[word_idx] = diff_out_word;
	}
}

//127||126||125||124||...||3||2||1||0
void GIFT256_inv_diffusion(DIFF_I_WRD_t * out, DIFF_O_WRD_t * in)
{
	char instatebit[256];
	char oustatebit[256];
	CNT_t word_idx;
	CNT_t inbit_idx;
	CNT_t bit_idx;

	//split to bits
	////Word_idx_order  :          0      ||...||      15 
	////InBit_idx_order : || 3|| 2|| 1|| 0||...|| 3|| 2|| 1|| 0||
	////Bit_idx_order   : || 0|| 1|| 2|| 3||...||60||61||62||63||
	for (word_idx = 0; word_idx < 64; word_idx++)
	{
		DIFF_O_WRD_t diff_word = in[word_idx];
		for (inbit_idx = 0; inbit_idx < 4; inbit_idx++)
		{
			bit_idx = 4 * word_idx;
			bit_idx += (4 - 1 - inbit_idx);

			if ((diff_word & (DIFF_O_WRD_t)(1 << inbit_idx)) != 0)
			{
				instatebit[bit_idx] = 1;
			}
			else
			{
				instatebit[bit_idx] = 0;
			}
		}
	}

	//bit permutation
	for (bit_idx = 0; bit_idx < 256; bit_idx++)
	{
		oustatebit[bit_idx] = instatebit[GIFT256_P_inv[bit_idx]];
	}

	//merge to state
	////Bit_idx_order   : || 0|| 1|| 2|| 3||...||60||61||62||63||
	////InBit_idx_order : || 3|| 2|| 1|| 0||...|| 3|| 2|| 1|| 0||
	////Word_idx_order  :          0      ||...||      15 

	for (word_idx = 0; word_idx < 64; word_idx++)
	{
		DIFF_O_WRD_t diff_out_word = 0x0;
		for (inbit_idx = 0; inbit_idx < 4; inbit_idx++)
		{
			DIFF_O_WRD_t mask = (((DIFF_O_WRD_t)1) << inbit_idx);

			bit_idx = 4 * word_idx;
			bit_idx += (4 - 1 - inbit_idx);
			if (oustatebit[bit_idx] == 0x1)
				diff_out_word = diff_out_word | mask;
		}
		out[word_idx] = diff_out_word;
	}
}

#define GIFT256_DC_KNOWN_BEST_ROUND 0

void GIFT256_set_known_prob_bound(PROB_t * B)
{
	// 0Round :nothing
	B[0] = (PROB_t)0;
};

#define GIFT256_LC_KNOWN_BEST_ROUND 0
void GIFT256_set_known_corr_bound(CORR_t * B)
{
	// 0 Round :  nothing
	B[0].sign = POSI; B[0].magnitude = (ABS_CORR_t)0;
};

#define GIFT256_NUM_ROUND 80
PROB_t GIFT256_each_round_initial_prob_bound[GIFT256_NUM_ROUND + 1] =
{
	(PROB_t)0, //0-round
	(PROB_t)-4,
	(PROB_t)-4,
	(PROB_t)-8,
	(PROB_t)-12,
	(PROB_t)-18,
	(PROB_t)-23,
	(PROB_t)-30,
	(PROB_t)-40,
};
CORR_t GIFT256_each_round_initial_corr_bound[GIFT256_NUM_ROUND + 1] =
{
	{POSI, (ABS_CORR_t)0}, //0-round
	{POSI, (ABS_CORR_t)-2},
	{POSI, (ABS_CORR_t)-3},
	{POSI, (ABS_CORR_t)-5},
	{POSI, (ABS_CORR_t)-7},
	{POSI, (ABS_CORR_t)-10},
	{POSI, (ABS_CORR_t)-15},
	{POSI, (ABS_CORR_t)-18},
	{POSI, (ABS_CORR_t)-21},
};

SEARCHING_START_OPT_t GIFT256_searching_start_opt =
{
	/*enable_1round_active_map*/
	TRUE,
	/*rotational_symmetric_equivalent*/
	FALSE,
};

SET_INITIAL_BOUND_OPT_t GIFT256_set_initial_bound_opt =
{
	/*enable_set_initial_prob_bound*/
	FALSE,
	/*each_round_initial_prob_bound*/
	GIFT256_each_round_initial_prob_bound,
	/*prob_interval*/
	(PROB_t)-5,
	/*enable_set_initial_corr_bound*/
	FALSE,
	/*each_round_initial_corr_bound*/
	GIFT256_each_round_initial_corr_bound,
	/*corr_interval*/
	{POSI, (ABS_CORR_t)-2.5}
};

DIFFUSION_BOUND_OPT_t GIFT256_diffusion_bound_opt =
{
	/*num_diff_of_partial_diffusion*/
	4,
	/*diff_branch_num*/
	UNKNOWN,
	/*inv_trans_diff_branch_num*/
	UNKNOWN
};

BLK_CIPHER_INFO_t GIFT256 =
{
	/*general information*/
	//algname
	"GIFT256",
	//alg_structure
	SPN,
	//num_round
	GIFT256_NUM_ROUND,
	//block_bit_size
	256,
	//key_bit_size
	256,
	//num_word_in_a_state
	64,

	/*about substitution*/
	//distinct_sbox
	FALSE,
	//sbox_i_word_bit_size
	4,
	//sbox_o_word_bit_size
	4,
	//sboxes
	GIFT256_sboxes,

	/*about diffusion*/
	//diffusion_info [what diffusion is used?(e.g., bit-permutation, matrix(partial), matrix(full))]
	BIT_PERMUTATION,
	/*diff_i_word_bit_size*/
	4,
	/*diff_o_word_bit_size*/
	4,
	//diffusion functions
	//Diffusion(DIFF_O_WRD_t *, DIFF_I_WRD_t *)
	GIFT256_diffusion,
	//Inv_Diffusion(DIFF_I_WRD_t *, DIFF_O_WRD_t *)
	GIFT256_inv_diffusion,
	//Inv_Trans_Diffusion(DIFF_O_WRD_t *, DIFF_I_WRD_t *)
	GIFT256_diffusion,
	//Trans_Diffusion(DIFF_I_WRD_t *, DIFF_O_WRD_t *)
	GIFT256_inv_diffusion,

	/*about bound info*/
	//dc_known_best_round
	GIFT256_DC_KNOWN_BEST_ROUND,
	//Set_Known_Prob_Bound
	GIFT256_set_known_prob_bound,
	//lc_known_best_round
	GIFT256_LC_KNOWN_BEST_ROUND,
	//Set_Known_Corr_Bound
	GIFT256_set_known_corr_bound,
	/*start searching opt ptr*/
	&GIFT256_searching_start_opt,
	&GIFT256_set_initial_bound_opt,
	&GIFT256_diffusion_bound_opt
};


void PY_GIFT256_DC_Prob_Searching(PROB_t * rst, CNT_t num_round, UFLAG_t vervose)
{
	SPN_Prep_Info_For_DC(&GIFT256);
	Use_Predefined_1Round_Active_Maps(&GIFT256);
	SPN_Best_DC_Prob_Search(rst, &GIFT256, 0, num_round, vervose);
}

void PY_GIFT256_LC_Corr_Searching(CORR_t * rst, CNT_t num_round, UFLAG_t vervose)
{
	SPN_Prep_Info_For_LC(&GIFT256);
	Use_Predefined_1Round_Active_Maps(&GIFT256);
	SPN_Best_LC_Corr_Search(rst, &GIFT256, 0, num_round, vervose);
}