#include "astbb.h"
#include "dif_prob.h"
#include "lin_corr.h"
#include "bit_perm_opt.h"

SBOX_O_WRD_t PRESENT128_sboxes[32 * 16] =
{
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,

	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2,
	0xC, 0x5, 0x6, 0xB, 0x9, 0x0, 0xA, 0xD, 0x3, 0xE, 0xF, 0x8, 0x4, 0x7, 0x1, 0x2
};

//Bit Permutation
//                H     ||        L
//word idx 0 1 2 ... 15 || 16 17 18 ... 31
void PRESENT128_diffusion(DIFF_O_WRD_t * out, DIFF_I_WRD_t * in)
{
	uint64_t H = 0ULL;
	uint64_t L = 0ULL;
	int i;
	for (i = 0; i < 16; i++)
	{
		H = (H << 4) | (in[i] & 0xf);
		L = (L << 4) | (in[i + 16] & 0xf);
	}
	//30 cycles, 6 masks
	bit_permute_step_128(&H, &L, H, L, 0x0a0a0a0a0a0a0a0aULL, 0x0a0a0a0a0a0a0a0aULL, 3);
	bit_permute_step_128(&H, &L, H, L, 0x00cc00cc00cc00ccULL, 0x00cc00cc00cc00ccULL, 6);
	bit_permute_step_128(&H, &L, H, L, 0x0000f0f00000f0f0ULL, 0x0000f0f00000f0f0ULL, 12);
	bit_permute_step_128(&H, &L, H, L, 0x00000000ff00ff00ULL, 0x00000000ff00ff00ULL, 24);
	bit_permute_step_128(&H, &L, H, L, 0x0000000000000000ULL, 0xffff0000ffff0000ULL, 48);
	bit_permute_step_128(&H, &L, H, L, 0x0000000000000000ULL, 0xffffffff00000000ULL, 32);

	for (i = 15; i >= 0; i--)
	{
		out[i] = (DIFF_O_WRD_t)(H & 0xf);
		H = H >> 4;
		out[i + 16] = (DIFF_O_WRD_t)(L & 0xf);
		L = L >> 4;
	}
}

//                H     ||        L
//word idx 0 1 2 ... 15 || 16 17 18 ... 31
void PRESENT128_inv_diffusion(DIFF_I_WRD_t * out, DIFF_O_WRD_t * in)
{
	uint64_t H = 0ULL;
	uint64_t L = 0ULL;
	int i;
	for (i = 0; i < 16; i++)
	{
		H = (H << 4) | (in[i] & 0xf);
		L = (L << 4) | (in[i + 16] & 0xf);
	}
	//30 cycles, 6 masks
	bit_permute_step_128(&H, &L, H, L, 0x00000000aaaaaaaaULL, 0x00000000aaaaaaaaULL, 31);
	bit_permute_step_128(&H, &L, H, L, 0x0000000000000000ULL, 0xccccccccccccccccULL, 62);
	bit_permute_step_128(&H, &L, H, L, 0x00000000f0f0f0f0ULL, 0x00000000f0f0f0f0ULL, 28);
	bit_permute_step_128(&H, &L, H, L, 0x0000000000000000ULL, 0xff00ff00ff00ff00ULL, 56);
	bit_permute_step_128(&H, &L, H, L, 0x00000000ffff0000ULL, 0x00000000ffff0000ULL, 16);
	bit_permute_step_128(&H, &L, H, L, 0x0000000000000000ULL, 0xffffffff00000000ULL, 32);

	for (i = 15; i >= 0; i--)
	{
		out[i] = (DIFF_I_WRD_t)(H & 0xf);
		H = H >> 4;
		out[i + 16] = (DIFF_I_WRD_t)(L & 0xf);
		L = L >> 4;
	}
}

#define PRESENT128_DC_KNOWN_BEST_ROUND 0

void PRESENT128_set_known_prob_bound(PROB_t * B)
{
	// 0 Round :  nothing
	B[0] = (PROB_t)0;
};

#define PRESENT128_LC_KNOWN_BEST_ROUND 0
void PRESENT128_set_known_corr_bound(CORR_t * B)
{
	// 0 Round :  nothing
	B[0].sign = POSI; B[0].magnitude = (ABS_CORR_t)0;
};

#define PRESENT128_NUM_ROUND 43
PROB_t PRESENT128_each_round_initial_prob_bound[PRESENT128_NUM_ROUND + 1] =
{
	(PROB_t)0, //0-round
};
CORR_t PRESENT128_each_round_initial_corr_bound[PRESENT128_NUM_ROUND + 1] =
{
	{POSI, (ABS_CORR_t)0}, //0-round
};

SEARCHING_START_OPT_t PRESENT128_searching_start_opt =
{
	/*enable_1round_active_map*/
	TRUE,
	/*rotational_symmetric_equivalent*/
	FALSE,
};

SET_INITIAL_BOUND_OPT_t PRESENT128_set_initial_bound_opt =
{
	/*enable_set_initial_prob_bound*/
	FALSE,
	/*each_round_initial_prob_bound*/
	PRESENT128_each_round_initial_prob_bound,
	/*prob_interval*/
	(PROB_t)-5,
	/*enable_set_initial_corr_bound*/
	FALSE,
	/*each_round_initial_corr_bound*/
	PRESENT128_each_round_initial_corr_bound,
	/*corr_interval*/
	{POSI, (ABS_CORR_t)-2.5}
};

DIFFUSION_BOUND_OPT_t PRESENT128_diffusion_bound_opt =
{
	/*num_diff_of_partial_diffusion*/
	4,
	/*diff_branch_num*/
	UNKNOWN,
	/*inv_trans_diff_branch_num*/
	UNKNOWN
};

BLK_CIPHER_INFO_t PRESENT128 =
{
	/*general information*/
	//algname
	"PRESENT128",
	//alg_structure
	SPN,
	//num_round
	PRESENT128_NUM_ROUND,
	//block_bit_size
	128,
	//key_bit_size
	128,
	//num_word_in_a_state
	32,

	/*about substitution*/
	//distinct_sbox
	FALSE,
	//sbox_i_word_bit_size
	4,
	//sbox_o_word_bit_size
	4,
	//sboxes
	PRESENT128_sboxes,

	/*about diffusion*/
	//diffusion_info [what diffusion is used?(e.g., bit-permutation, matrix(partial), matrix(full))]
	BIT_PERMUTATION,
	/*diff_i_word_bit_size*/
	4,
	/*diff_o_word_bit_size*/
	4,
	//diffusion functions
	//Diffusion(DIFF_O_WRD_t *, DIFF_I_WRD_t *)
	PRESENT128_diffusion,
	//Inv_Diffusion(DIFF_I_WRD_t *, DIFF_O_WRD_t *)
	PRESENT128_inv_diffusion,
	//Inv_Trans_Diffusion(DIFF_O_WRD_t *, DIFF_I_WRD_t *)
	PRESENT128_diffusion,
	//Trans_Diffusion(DIFF_I_WRD_t *, DIFF_O_WRD_t *)
	PRESENT128_inv_diffusion,

	/*about bound info*/
	//dc_known_best_round
	PRESENT128_DC_KNOWN_BEST_ROUND,
	//Set_Known_Prob_Bound
	PRESENT128_set_known_prob_bound,
	//lc_known_best_round
	PRESENT128_LC_KNOWN_BEST_ROUND,
	//Set_Known_Corr_Bound
	PRESENT128_set_known_corr_bound,
	/*start searching opt ptr*/
	&PRESENT128_searching_start_opt,
	&PRESENT128_set_initial_bound_opt,
	&PRESENT128_diffusion_bound_opt
};


void PY_PRESENT128_DC_Prob_Searching(PROB_t * rst, CNT_t num_round, UFLAG_t verbose)
{
	SPN_Prep_Info_For_DC(&PRESENT128);
	Use_Predefined_1Round_Active_Maps(&PRESENT128);
	SPN_Best_DC_Prob_Search(rst, &PRESENT128, 0, num_round, verbose);
}

void PY_PRESENT128_LC_Corr_Searching(CORR_t * rst, CNT_t num_round, UFLAG_t verbose)
{
	SPN_Prep_Info_For_LC(&PRESENT128);
	Use_Predefined_1Round_Active_Maps(&PRESENT128);
	SPN_Best_LC_Corr_Search(rst, &PRESENT128, 0, num_round, verbose);
}