#include "astbb.h"
#include "dif_prob.h"
#include "lin_corr.h"
#include "bit_perm_opt.h"

SBOX_O_WRD_t SPONGENT176_sboxes[44 * 16] =
{
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //1

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //2

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //3

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //4

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //5

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //6
	
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //7

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //8

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //9

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //10

	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6,
	0xE, 0xD, 0xB, 0x0, 0x2, 0x1, 0x4, 0xF, 0x7, 0xA, 0x8, 0x5, 0x9, 0xC, 0x3, 0x6, //11
};

//Bit Permutation
//              x[0]   || x[1]   ||    ...      ||x[10] 
//word_idx     0 1 2 3   4 5 6 7       ...        40 41 42 43
void SPONGENT176_diffusion(DIFF_O_WRD_t * out, DIFF_I_WRD_t * in)
{
	uint16_t x[11] = { 0, };
	int i;
	for (i = 0; i < 4; i++)
	{
		x[ 0] = (x[ 0] << 4) | (uint16_t)(in[i    ] & 0xf);
		x[ 1] = (x[ 1] << 4) | (uint16_t)(in[i + 4] & 0xf);
		x[ 2] = (x[ 2] << 4) | (uint16_t)(in[i + 8] & 0xf);
		x[ 3] = (x[ 3] << 4) | (uint16_t)(in[i +12] & 0xf);
		x[ 4] = (x[ 4] << 4) | (uint16_t)(in[i +16] & 0xf);
		x[ 5] = (x[ 5] << 4) | (uint16_t)(in[i +20] & 0xf);
		x[ 6] = (x[ 6] << 4) | (uint16_t)(in[i +24] & 0xf);
		x[ 7] = (x[ 7] << 4) | (uint16_t)(in[i +28] & 0xf);
		x[ 8] = (x[ 8] << 4) | (uint16_t)(in[i +32] & 0xf);
		x[ 9] = (x[ 9] << 4) | (uint16_t)(in[i +36] & 0xf);
		x[10] = (x[10] << 4) | (uint16_t)(in[i +40] & 0xf);
	}

	bit_permute_step_16(x, x[0], 0x0a0a, 3);
	bit_permute_step_16(x, x[0], 0x00cc, 6);

	bit_permute_step_16(x + 1, x[1], 0x0a0a, 3);
	bit_permute_step_16(x + 1, x[1], 0x00cc, 6);

	bit_permute_step_16(x + 2, x[2], 0x0a0a, 3);
	bit_permute_step_16(x + 2, x[2], 0x00cc, 6);

	bit_permute_step_16(x + 3, x[3], 0x0a0a, 3);
	bit_permute_step_16(x + 3, x[3], 0x00cc, 6);

	bit_permute_step_16(x + 4, x[4], 0x0a0a, 3);
	bit_permute_step_16(x + 4, x[4], 0x00cc, 6);

	bit_permute_step_16(x + 5, x[5], 0x0a0a, 3);
	bit_permute_step_16(x + 5, x[5], 0x00cc, 6);

	bit_permute_step_16(x + 6, x[6], 0x0a0a, 3);
	bit_permute_step_16(x + 6, x[6], 0x00cc, 6);

	bit_permute_step_16(x + 7, x[7], 0x0a0a, 3);
	bit_permute_step_16(x + 7, x[7], 0x00cc, 6);

	bit_permute_step_16(x + 8, x[8], 0x0a0a, 3);
	bit_permute_step_16(x + 8, x[8], 0x00cc, 6);

	bit_permute_step_16(x + 9, x[9], 0x0a0a, 3);
	bit_permute_step_16(x + 9, x[9], 0x00cc, 6);

	bit_permute_step_16(x + 10, x[10], 0x0a0a, 3);
	bit_permute_step_16(x + 10, x[10], 0x00cc, 6);

	//shuffle
	for (i = 0; i < 11; i++)
	{
		out[0 + i]  = (DIFF_O_WRD_t)((x[i]>>12) & 0xf);
		out[11 + i] = (DIFF_O_WRD_t)((x[i]>>8) & 0xf);
		out[22 + i] = (DIFF_O_WRD_t)((x[i]>>4) & 0xf);
		out[33 + i] = (DIFF_O_WRD_t)((x[i]>>0) & 0xf);
	}
}

void SPONGENT176_inv_diffusion(DIFF_I_WRD_t * out, DIFF_O_WRD_t * in)
{
	uint16_t x[11] = { 0, };
	int i;
	//Inverse shuffle
	for (i = 0; i < 11; i++)
	{
		x[i]  = (uint16_t)(((in[0  + i]) & 0xf) << 12);
		x[i] |= (uint16_t)(((in[11 + i]) & 0xf) << 8);
		x[i] |= (uint16_t)(((in[22 + i]) & 0xf) << 4);
		x[i] |= (uint16_t)(((in[33 + i]) & 0xf) << 0);
	}
	

	bit_permute_step_16(x, x[0], 0x0a0a, 3);
	bit_permute_step_16(x, x[0], 0x00cc, 6);
	
	bit_permute_step_16(x + 1, x[1], 0x0a0a, 3);
	bit_permute_step_16(x + 1, x[1], 0x00cc, 6);
	
	bit_permute_step_16(x + 2, x[2], 0x0a0a, 3);
	bit_permute_step_16(x + 2, x[2], 0x00cc, 6);
	
	bit_permute_step_16(x + 3, x[3], 0x0a0a, 3);
	bit_permute_step_16(x + 3, x[3], 0x00cc, 6);
	
	bit_permute_step_16(x + 4, x[4], 0x0a0a, 3);
	bit_permute_step_16(x + 4, x[4], 0x00cc, 6);
	
	bit_permute_step_16(x + 5, x[5], 0x0a0a, 3);
	bit_permute_step_16(x + 5, x[5], 0x00cc, 6);
	
	bit_permute_step_16(x + 6, x[6], 0x0a0a, 3);
	bit_permute_step_16(x + 6, x[6], 0x00cc, 6);
	
	bit_permute_step_16(x + 7, x[7], 0x0a0a, 3);
	bit_permute_step_16(x + 7, x[7], 0x00cc, 6);
	
	bit_permute_step_16(x + 8, x[8], 0x0a0a, 3);
	bit_permute_step_16(x + 8, x[8], 0x00cc, 6);
	
	bit_permute_step_16(x + 9, x[9], 0x0a0a, 3);
	bit_permute_step_16(x + 9, x[9], 0x00cc, 6);
	 
	bit_permute_step_16(x + 10, x[10], 0x0a0a, 3);
	bit_permute_step_16(x + 10, x[10], 0x00cc, 6);

	for (i = 0; i < 11; i++)
	{
		out[4 * i    ] = (DIFF_O_WRD_t)((x[i] >> 12) & 0xf);
		out[4 * i + 1] = (DIFF_O_WRD_t)((x[i] >> 8) & 0xf);
		out[4 * i + 2] = (DIFF_O_WRD_t)((x[i] >> 4) & 0xf);
		out[4 * i + 3] = (DIFF_O_WRD_t)((x[i] >> 0) & 0xf);
	}
}

#define SPONGENT176_DC_KNOWN_BEST_ROUND 0

void SPONGENT176_set_known_prob_bound(PROB_t * B)
{
	// 0 Round :  nothing
	B[0] = (PROB_t)0;
};

#define SPONGENT176_LC_KNOWN_BEST_ROUND 0
void SPONGENT176_set_known_corr_bound(CORR_t * B)
{
	// 0 Round :  nothing
	B[0].sign = POSI; B[0].magnitude = (ABS_CORR_t)0;
};

#define SPONGENT176_NUM_ROUND 90
PROB_t SPONGENT176_each_round_initial_prob_bound[SPONGENT176_NUM_ROUND + 1] =
{
	(PROB_t)0, //0-round
};
CORR_t SPONGENT176_each_round_initial_corr_bound[SPONGENT176_NUM_ROUND + 1] =
{
	{POSI, (ABS_CORR_t)0}, //0-round
};

SEARCHING_START_OPT_t SPONGENT176_searching_start_opt =
{
	/*enable_1round_active_map*/
	TRUE,
	/*rotational_symmetric_equivalent*/
	FALSE,
};

SET_INITIAL_BOUND_OPT_t SPONGENT176_set_initial_bound_opt =
{
	/*enable_set_initial_prob_bound*/
	FALSE,
	/*each_round_initial_prob_bound*/
	SPONGENT176_each_round_initial_prob_bound,
	/*prob_interval*/
	(PROB_t)-5,
	/*enable_set_initial_corr_bound*/
	FALSE,
	/*each_round_initial_corr_bound*/
	SPONGENT176_each_round_initial_corr_bound,
	/*corr_interval*/
	{POSI, (ABS_CORR_t)-2.5}
};

DIFFUSION_BOUND_OPT_t SPONGENT176_diffusion_bound_opt =
{
	/*num_diff_of_partial_diffusion*/
	4,
	/*diff_branch_num*/
	UNKNOWN,
	/*inv_trans_diff_branch_num*/
	UNKNOWN
};

BLK_CIPHER_INFO_t SPONGENT176 =
{
	/*general information*/
	//algname
	"SPONGENT176",
	//alg_structure
	SPN,
	//num_round
	SPONGENT176_NUM_ROUND,
	//block_bit_size
	176,
	//key_bit_size
	0,
	//num_word_in_a_state
	44,

	/*about substitution*/
	//distinct_sbox
	FALSE,
	//sbox_i_word_bit_size
	4,
	//sbox_o_word_bit_size
	4,
	//sboxes
	SPONGENT176_sboxes,

	/*about diffusion*/
	//diffusion_info [what diffusion is used?(e.g., bit-permutation, matrix(partial), matrix(full))]
	BIT_PERMUTATION,
	/*diff_i_word_bit_size*/
	4,
	/*diff_o_word_bit_size*/
	4,
	//diffusion functions
	//Diffusion(DIFF_O_WRD_t *, DIFF_I_WRD_t *)
	SPONGENT176_diffusion,
	//Inv_Diffusion(DIFF_I_WRD_t *, DIFF_O_WRD_t *)
	SPONGENT176_inv_diffusion,
	//Inv_Trans_Diffusion(DIFF_O_WRD_t *, DIFF_I_WRD_t *)
	SPONGENT176_diffusion,
	//Trans_Diffusion(DIFF_I_WRD_t *, DIFF_O_WRD_t *)
	SPONGENT176_inv_diffusion,

	/*about bound info*/
	//dc_known_best_round
	SPONGENT176_DC_KNOWN_BEST_ROUND,
	//Set_Known_Prob_Bound
	SPONGENT176_set_known_prob_bound,
	//lc_known_best_round
	SPONGENT176_LC_KNOWN_BEST_ROUND,
	//Set_Known_Corr_Bound
	SPONGENT176_set_known_corr_bound,
	/*start searching opt ptr*/
	&SPONGENT176_searching_start_opt,
	&SPONGENT176_set_initial_bound_opt,
	&SPONGENT176_diffusion_bound_opt
};



void PY_SPONGENT176_DC_Prob_Searching(PROB_t * rst, CNT_t num_round, UFLAG_t verbose)
{
	SPN_Prep_Info_For_DC(&SPONGENT176);
	Use_Predefined_1Round_Active_Maps(&SPONGENT176);
	SPN_Best_DC_Prob_Search(rst, &SPONGENT176, 0, num_round, verbose);
}

void PY_SPONGENT176_LC_Corr_Searching(CORR_t * rst, CNT_t num_round, UFLAG_t verbose)
{
	SPN_Prep_Info_For_LC(&SPONGENT176);
	Use_Predefined_1Round_Active_Maps(&SPONGENT176);
	SPN_Best_LC_Corr_Search(rst, &SPONGENT176, 0, num_round, verbose);
}